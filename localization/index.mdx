---
title: Localization
---

# Localization

Flowxi is **localization-first by design**.

Every API response, validation error, authentication message, and transactional email
is returned in a **single, deterministic locale**, resolved at the **very beginning** of the request lifecycle.

There is **no partial localization** and **no ambiguity**.

---

## Supported locales

Flowxi currently supports:

- `fr` — **default and mandatory fallback**
- `en`

Any unsupported or malformed locale will **always fall back to `fr`**.

This behavior is enforced at middleware level and cannot be bypassed.

---

## How locale is resolved (exact order)

For **every API request**, Flowxi resolves the locale in the following strict order:

1. **Custom header** `X-App-Locale`
2. **Standard header** `Accept-Language`
3. **Authenticated user locale** (`user.locale`)
4. **Fallback locale** (`fr`)

The **first valid supported locale wins**.

---

## 1) `X-App-Locale` (highest priority)

This is the **primary and recommended mechanism**.

### Example

```http
X-App-Locale: en
```

Behavior:

- Overrides **all other sources**
- Works for **public and authenticated** endpoints
- Controls:
  - API `message`
  - validation messages
  - authentication errors
  - emails sent during the request

### Frontend rule (important)

Always send `X-App-Locale` on **every API request**, including after login.

Do **not** rely on backend inference.

---

## 2) `Accept-Language`

Used **only if** `X-App-Locale` is absent.

### Example

```http
Accept-Language: en-US,en;q=0.9,fr;q=0.8
```

Parsing rules (from middleware):

- Values are split by `,`
- `;q=` values are ignored
- `_` is normalized to `-`
- Region is stripped (`en-US` → `en`)
- First supported base language wins

### Resolution examples

| Header value              | Effective locale |
|---------------------------|------------------|
| `en-US,en;q=0.9`          | `en`             |
| `fr-FR,fr;q=0.8`          | `fr`             |
| `es,pt;q=0.9`             | fallback `fr`    |

---

## 3) Authenticated user locale (`user.locale`)

If **no locale header** is provided and the request is authenticated:

- Flowxi checks `user.locale`
- If it matches a supported locale, it is applied

This is mainly useful for:
- background API calls
- internal service calls
- recovery when headers are missing

It is **never preferred** over headers.

---

## 4) Fallback locale (guaranteed)

If no valid locale is resolved:

- Flowxi **always** falls back to `fr`

This fallback is:
- deterministic
- mandatory
- never throws

---

## Effective locale lifecycle

Once resolved by `SetLocaleFromRequest` middleware:

- `app()->setLocale(locale)` is executed
- The locale is stored as `effective_locale` in the request
- Controllers and mailers **reuse the same locale**
- No later override is allowed

There is **exactly one locale per request**.

---

## What is localized

The resolved locale applies to:

- `message` in all API responses
- validation error messages
- authentication & security errors
- transactional emails (magic link, OTP, etc.)

### Example

```json
{
  "message": "Invalid credentials.",
  "code": "INVALID_CREDENTIALS"
}
```

Same request with `X-App-Locale: fr`:

```json
{
  "message": "Identifiants invalides.",
  "code": "INVALID_CREDENTIALS"
}
```

---

## What is NOT localized (by design)

The following are **never translated**:

- `code` values
- enum values
- JSON keys
- field names

Frontend logic **must rely on `code`**, never on `message`.

---

## Email localization

All authentication emails explicitly set locale:

- Magic link emails
- Email OTP codes

Mechanism:

- Controller resolves locale
- `Mail::to(...)->locale($lang)`
- `__()` translations use the same locale

Emails **always match API language**.

---

## Frontend integration examples

### Axios

```ts
api.interceptors.request.use((config) => {
  config.headers["X-App-Locale"] = getUserLocale(); // "fr" | "en"
  return config;
});
```

### Fetch

```ts
fetch("/api/v1/auth/login", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "X-App-Locale": "en",
  },
  body: JSON.stringify(payload),
});
```

### Authenticated requests

```http
Authorization: Bearer <token>
X-App-Locale: fr
```

---

## Frontend responsibilities

- Let the user choose a language
- Store it client-side
- Send it **on every request**

Updating `user.locale` server-side is optional and used only as a fallback.

---

## Guarantees

Flowxi guarantees:

- Exactly **one locale per request**
- No mixed-language responses
- Mandatory fallback to `fr`
- Consistent API + email language
- No reliance on browser heuristics

---

## Testing checklist

- Send `X-App-Locale: fr` → verify French everywhere
- Send `X-App-Locale: en` → verify English everywhere
- Remove headers → fallback to `fr`
- Authenticated request without headers → uses `user.locale`
- Emails are sent in the same locale as the API response
